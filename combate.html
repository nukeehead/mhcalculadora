<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CombateMHRPG</title>
    <link rel="stylesheet" href="combat.css">
</head>
<body>
<header>
    <a class="logo-link">
        <img src="logo.png" alt="Logo de la calculadora">
    </a>
    <nav>
        <a class="nav-btn" href="index.html">Inicio</a>
        <a class="nav-btn" href="combate.html">Combate</a>
        <a class="nav-btn" href="comandos.html">Comandos</a>
    </nav>
</header>
<main class="combate-main">
    <section class="panel-combate">

        <div class="columna-izquierda">
            <div class="accion-container">
                <form id="form-ofensiva" class="form-accion form-accion-dos-col">
                    <div class="accion-grid">
                        <div class="accion-row">
                            <label for="accion-jugador">Quien ataca:</label>
                            <select id="accion-jugador"></select>
                        </div>
                        <div class="accion-row">
                            <label for="accion-habilidad-of">Habilidad (nombre):</label>
                            <input type="text" id="accion-habilidad-of" maxlength="32" placeholder="Nombre de la habilidad">
                        </div>
                        <div class="accion-row">
                            <label for="accion-dano">Daño:</label>
                            <input type="number" id="accion-dano" value="0" style="width:80px;">
                        </div>
                        <div class="accion-row">
                            <label for="accion-pa">PA gastados:</label>
                            <input type="number" id="accion-pa" min="0" max="8" value="1" style="width:60px;">
                        </div>
                        <div class="accion-row">
                            <label for="accion-vel">VEL gastada:</label>
                            <input type="number" id="accion-vel" min="0" max="99" value="0" style="width:60px;">
                        </div>
                        <div class="accion-row">
                            <label for="accion-objetivo">Objetivo:</label>
                            <select id="accion-objetivo"></select>
                        </div>
                    </div>
                    <div class="accion-row accion-row-full">
                        <label for="accion-extra">Extras:</label>
                        <input type="text" id="accion-extra" maxlength="64" placeholder="Notas, efectos, etc.">
                    </div>
                    <div class="accion-row accion-row-full">
                        <button type="submit" class="btn-control" style="margin-top:10px;width:100%;">Registrar ofensiva</button>
                    </div>
                </form>
            </div>
            <div class="accion-container">
                <form id="form-defensiva" class="form-accion form-accion-dos-col">
                    <div class="accion-grid">
                        <div class="accion-row">
                            <label for="accion-defensor">Quien recibe:</label>
                            <select id="accion-defensor"></select>
                        </div>
                        <div class="accion-row">
                            <label for="accion-habilidad-def">Habilidad defensiva (nombre):</label>
                            <input type="text" id="accion-habilidad-def" maxlength="32" placeholder="Nombre de la defensa">
                        </div>
                        <div class="accion-row">
                            <label for="accion-defensa">Defensa (solo para ti):</label>
                            <input type="number" id="accion-defensa" value="" style="width:80px;" placeholder="Defensa usada">
                        </div>
                        <div class="accion-row">
                            <label for="accion-dano-real">Lo que recibe:</label>
                            <input type="number" id="accion-dano-real" value="" style="width:80px;" placeholder="Daño recibido">
                        </div>
                        <div class="accion-row">
                            <label for="accion-pa-defensa">PA gastados:</label>
                            <input type="number" id="accion-pa-defensa" min="0" max="8" value="0" style="width:60px;">
                        </div>
                        <div class="accion-row">
                            <label for="accion-vel-defensa">VEL gastada:</label>
                            <input type="number" id="accion-vel-defensa" min="0" max="99" value="0" style="width:60px;">
                        </div>
                    </div>
                    <div class="accion-row accion-row-full">
                        <label for="accion-desc">Extras:</label>
                        <input type="text" id="accion-desc" maxlength="64" placeholder="Notas, efectos, etc.">
                    </div>
                    <div class="accion-row accion-row-full">
                        <button type="submit" class="btn-control" style="margin-top:10px;width:100%;">Registrar defensiva</button>
                    </div>
                </form>
            </div>
            <div class="registro-combate-container">
                <div class="registro-combate-lista">
                    <table class="tabla-registro-combate">
                        <thead>
                            <tr>
                                <th>Ronda</th>
                                <th>Turno</th>
                                <th>Tipo</th>
                                <th>Quien</th>
                                <th>Habilidad</th>
                                <th>PA</th>
                                <th>VEL</th>
                                <th>Daño/Defensa</th>
                                <th>Objetivo/Recibe</th>
                                <th>Extras</th>
                            </tr>
                        </thead>
                        <tbody id="registro-combate-body">
                        </tbody>
                    </table>
                </div>
                <div class="controles-combate">
                     <button id="btn-pasar-turno" class="btn-control btn-turno">PT</button>
                     <button id="btn-pasar-ronda" class="btn-control btn-ronda">Ronda</button>
                     <button id="btn-limpiar-historial" class="btn-control btn-limpiar">Limpiar</button>
                </div>
            </div>
        </div>

        <div class="columna-derecha">
            <div class="cuadro-bando cuadro-aliados">
                <h2>Aliados</h2>
                <table class="tabla-bando" id="tabla-aliados">
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>VIT</th>
                            <th>VEL</th>
                            <th>PA</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="aliados-body"></tbody>
                </table>
                <button class="btn-agregar" id="agregar-aliado">+ Añadir aliado</button>
            </div>
            <div class="cuadro-bando cuadro-enemigos">
                <h2>Enemigos</h2>
                <table class="tabla-bando" id="tabla-enemigos">
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>VIT</th>
                            <th>VEL</th>
                            <th>PA</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="enemigos-body"></tbody>
                </table>
                <button class="btn-agregar" id="agregar-enemigo">+ Añadir enemigo</button>
            </div>
            <aside class="chat-notas chat-notas-alta">
                <h2>Notas y habilidades pasivas</h2>
                <div id="chat-mensajes" class="chat-mensajes"></div>
                <form id="form-chat" autocomplete="off">
                    <input type="text" id="input-chat" maxlength="120" placeholder="Escribe una nota o habilidad...">
                    <button type="submit" class="btn-chat">Enviar</button>
                </form>
            </aside>
        </div>
    </section>
</main>
<script>
    let aliados = [
        { nombre: "Tú", vit: 1000, vel: 10, pa: 8 },
    ];
    let enemigos = [];
    let acciones = [];
    let chatMensajes = [];

    function getSelectedOption(select) {
        return select ? select.value : "";
    }
    function setSelectedOption(select, value) {
        if (!select) return;
        for (let i = 0; i < select.options.length; i++) {
            if (select.options[i].value === value) {
                select.selectedIndex = i;
                break;
            }
        }
    }

    function renderBando(bando, tbodyId, max, tipo) {
        const tbody = document.getElementById(tbodyId);
        tbody.innerHTML = "";
        bando.forEach((p, idx) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td><input type="text" value="${p.nombre}" class="input-nombre" data-idx="${idx}" data-tipo="${tipo}" maxlength="20"></td>
                <td><input type="number" value="${p.vit}" class="input-vit" data-idx="${idx}" data-tipo="${tipo}" min="0" max="99999"></td>
                <td><input type="number" value="${p.vel}" class="input-vel" data-idx="${idx}" data-tipo="${tipo}" min="0" max="99"></td>
                <td><input type="number" value="${p.pa}" class="input-pa" data-idx="${idx}" data-tipo="${tipo}" min="0" max="8"></td>
                <td>
                    ${idx > 0 || tipo === "enemigos" ? `<button class="btn-quitar" data-idx="${idx}" data-tipo="${tipo}">✖</button>` : ""}
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    function renderBandos() {
        renderBando(aliados, "aliados-body", 3, "aliados");
        renderBando(enemigos, "enemigos-body", 3, "enemigos");
        renderAccionSelects();
        guardarDatos();
    }

    function renderAccionSelects() {
        const jugadorSel = document.getElementById("accion-jugador")?.value || "";
        const objetivoSel = document.getElementById("accion-objetivo")?.value || "";
        const defensorSel = document.getElementById("accion-defensor")?.value || "";

        const selJugador = document.getElementById("accion-jugador");
        const selObjetivo = document.getElementById("accion-objetivo");
        const selDefensor = document.getElementById("accion-defensor");

        if (selJugador) {
            selJugador.innerHTML = "";
            aliados.forEach((a, i) => {
                const opt = document.createElement("option");
                opt.value = "aliado-" + i;
                opt.textContent = a.nombre + " (Aliado)";
                selJugador.appendChild(opt);
            });
            enemigos.forEach((e, i) => {
                const opt = document.createElement("option");
                opt.value = "enemigo-" + i;
                opt.textContent = e.nombre + " (Enemigo)";
                selJugador.appendChild(opt);
            });
            selJugador.value = jugadorSel || selJugador.options[0]?.value || "";
        }

        if (selObjetivo) {
            selObjetivo.innerHTML = "";
            aliados.forEach((a, i) => {
                const opt = document.createElement("option");
                opt.value = "aliado-" + i;
                opt.textContent = a.nombre + " (Aliado)";
                selObjetivo.appendChild(opt);
            });
            enemigos.forEach((e, i) => {
                const opt = document.createElement("option");
                opt.value = "enemigo-" + i;
                opt.textContent = e.nombre + " (Enemigo)";
                selObjetivo.appendChild(opt);
            });
            selObjetivo.value = objetivoSel || selObjetivo.options[0]?.value || "";
        }

        if (selDefensor) {
            selDefensor.innerHTML = "";
            aliados.forEach((a, i) => {
                const opt = document.createElement("option");
                opt.value = "aliado-" + i;
                opt.textContent = a.nombre + " (Aliado)";
                selDefensor.appendChild(opt);
            });
            enemigos.forEach((e, i) => {
                const opt = document.createElement("option");
                opt.value = "enemigo-" + i;
                opt.textContent = e.nombre + " (Enemigo)";
                selDefensor.appendChild(opt);
            });
            selDefensor.value = defensorSel || selDefensor.options[0]?.value || "";
        }
    }

    document.getElementById("agregar-aliado").onclick = function() {
        if (aliados.length < 3) {
            aliados.push({ nombre: "Aliado " + aliados.length, vit: 1000, vel: 10, pa: 8 });
            renderBandos();
        }
    };
    document.getElementById("agregar-enemigo").onclick = function() {
        if (enemigos.length < 3) {
            enemigos.push({ nombre: "Enemigo " + (enemigos.length + 1), vit: 1000, vel: 10, pa: 8 });
            renderBandos();
        }
    };

    document.addEventListener("click", function(e) {
        if (e.target.classList.contains("btn-quitar")) {
            const idx = Number(e.target.getAttribute("data-idx"));
            const tipo = e.target.getAttribute("data-tipo");
            if (tipo === "aliados" && idx > 0) aliados.splice(idx, 1);
            if (tipo === "enemigos") enemigos.splice(idx, 1);
            renderBandos();
        }
    });

    document.addEventListener("input", function(e) {
        const idx = Number(e.target.getAttribute("data-idx"));
        const tipo = e.target.getAttribute("data-tipo");
        if (tipo && !isNaN(idx)) {
            if (e.target.classList.contains("input-nombre")) {
                if (tipo === "aliados") aliados[idx].nombre = e.target.value;
                else enemigos[idx].nombre = e.target.value;
            }
            if (e.target.classList.contains("input-vit")) {
                if (tipo === "aliados") aliados[idx].vit = Number(e.target.value);
                else enemigos[idx].vit = Number(e.target.value);
            }
            if (e.target.classList.contains("input-vel")) {
                if (tipo === "aliados") aliados[idx].vel = Number(e.target.value);
                else enemigos[idx].vel = Number(e.target.value);
            }
            if (e.target.classList.contains("input-pa")) {
                if (tipo === "aliados") aliados[idx].pa = Number(e.target.value);
                else enemigos[idx].pa = Number(e.target.value);
            }
        }
    });

    let rondaActual = 1;
    let turnoActual = 1;

    let ultimoDanoOfensivo = null;

    function renderRegistroCombate() {
        const tbody = document.getElementById("registro-combate-body");
        if (!tbody) return;
        if (acciones.length === 0) {
            tbody.innerHTML = `<tr><td colspan="10" style="text-align:center;color:#aaa;"><em>El registro de acciones aparecerá aquí.</em></td></tr>`;
            return;
        }
        tbody.innerHTML = acciones.map((a, i) => `
            <tr class="tipo-${a.tipo}">
                <td>${a.ronda}</td>
                <td>${a.turno}</td>
                <td>${a.tipo === "ofensiva" ? "Ofensiva" : "Defensiva"}</td>
                <td>${a.quien}</td>
                <td>${a.habilidad || "-"}</td>
                <td>${a.pa}</td>
                <td>${a.vel}</td>
                <td>${a.valor}</td>
                <td>${a.objetivo || a.recibe || "-"}</td>
                <td>${a.extras || ""}</td>
            </tr>
        `).join("");
    }

    document.getElementById("form-ofensiva").onsubmit = function(e) {
        e.preventDefault();
        const jugadorSel = document.getElementById("accion-jugador").value;
        const habilidadOf = document.getElementById("accion-habilidad-of").value.trim();
        const dano = Number(document.getElementById("accion-dano").value) || 0;
        const pa = Number(document.getElementById("accion-pa").value) || 0;
        const vel = Number(document.getElementById("accion-vel").value) || 0;
        const objetivoSel = document.getElementById("accion-objetivo").value;
        const extra = document.getElementById("accion-extra").value.trim();

        let jugador = null, jugadorNombre = "";
        if (jugadorSel.startsWith("aliado-")) {
            jugador = aliados[Number(jugadorSel.split("-")[1])];
            jugadorNombre = jugador ? jugador.nombre : "";
        } else if (jugadorSel.startsWith("enemigo-")) {
            jugador = enemigos[Number(jugadorSel.split("-")[1])];
            jugadorNombre = jugador ? jugador.nombre : "";
        }
        let objetivo = null, objetivoNombre = "";
        if (objetivoSel.startsWith("aliado-")) {
            objetivo = aliados[Number(objetivoSel.split("-")[1])];
            objetivoNombre = objetivo ? objetivo.nombre : "";
        } else if (objetivoSel.startsWith("enemigo-")) {
            objetivo = enemigos[Number(objetivoSel.split("-")[1])];
            objetivoNombre = objetivo ? objetivo.nombre : "";
        }

        ultimoDanoOfensivo = dano;
        window.ultimoDanoOfensivo = dano;

        if (jugador && jugador.pa < pa) {
            alert("El atacante no tiene suficientes PA.");
            return;
        }
        if (jugador) {
            jugador.pa = Math.max(0, jugador.pa - pa);
            jugador.vel = Math.max(0, jugador.vel - vel);
        }

        acciones.push({
            ronda: rondaActual,
            turno: turnoActual,
            tipo: "ofensiva",
            quien: jugadorNombre,
            habilidad: habilidadOf,
            pa: pa,
            vel: vel,
            valor: dano,
            objetivo: objetivoNombre,
            extras: extra
        });
        renderBandos();
        renderRegistroCombate();

        document.getElementById("accion-habilidad-of").value = "";
        document.getElementById("accion-dano").value = 0;
        document.getElementById("accion-pa").value = 1;
        document.getElementById("accion-vel").value = 0;
        document.getElementById("accion-extra").value = "";
    };

    document.getElementById("form-defensiva").onsubmit = function(e) {
        e.preventDefault();
        const defensorSel = document.getElementById("accion-defensor").value;
        const habilidadDef = document.getElementById("accion-habilidad-def").value.trim();
        const defensa = document.getElementById("accion-defensa").value !== "" ? Number(document.getElementById("accion-defensa").value) : null;
        const danoReal = document.getElementById("accion-dano-real").value !== "" ? Number(document.getElementById("accion-dano-real").value) : null;
        const paDefensa = Number(document.getElementById("accion-pa-defensa").value) || 0;
        const velDefensa = Number(document.getElementById("accion-vel-defensa").value) || 0;
        const extras = document.getElementById("accion-desc").value.trim();

        let defensor = null, defensorNombre = "";
        if (defensorSel.startsWith("aliado-")) {
            defensor = aliados[Number(defensorSel.split("-")[1])];
            defensorNombre = defensor ? defensor.nombre : "";
        } else if (defensorSel.startsWith("enemigo-")) {
            defensor = enemigos[Number(defensorSel.split("-")[1])];
            defensorNombre = defensor ? defensor.nombre : "";
        }

        if ((defensa !== null || danoReal !== null) && defensor && defensor.pa < paDefensa) {
            alert("El defensor no tiene suficientes PA.");
            return;
        }

        if (defensor) {
            defensor.pa = Math.max(0, defensor.pa - paDefensa);
            defensor.vel = Math.max(0, defensor.vel - velDefensa);

            let recibeValor = "-";
            let detalle = "";
            
            if (defensorSel === "aliado-0" && typeof ultimoDanoOfensivo === "number" && defensa !== null && defensa !== "") {
                const resistencia = Number(localStorage.getItem("ATRIB_RES")) || 0;
                const reduccion = Number(localStorage.getItem("ATRIB_REP")) || 1;
                recibeValor = ((ultimoDanoOfensivo - resistencia) - defensa) * reduccion;
                detalle = ` [(${ultimoDanoOfensivo} - ${resistencia} - ${defensa}) * ${reduccion}] = ${recibeValor}`;
                defensor.vit = Math.max(0, defensor.vit - recibeValor);
            }
            else if (defensorSel.startsWith("aliado-") && danoReal !== null && danoReal !== "") {
                recibeValor = danoReal;
                defensor.vit = Math.max(0, defensor.vit - danoReal);
            }
            else if (defensorSel.startsWith("enemigo-") && danoReal !== null && danoReal !== "") {
                recibeValor = danoReal;
                defensor.vit = Math.max(0, defensor.vit - danoReal);
            }

            acciones.push({
                ronda: rondaActual,
                turno: turnoActual,
                tipo: "defensiva",
                quien: defensorNombre,
                habilidad: habilidadDef,
                pa: paDefensa,
                vel: velDefensa,
                valor: defensa !== null && defensa !== "" ? defensa : "-",
                recibe: recibeValor !== null && recibeValor !== "" ? recibeValor + detalle : "-",
                extras: extras
            });
        }
        renderBandos();
        renderRegistroCombate();

        document.getElementById("accion-habilidad-def").value = "";
        document.getElementById("accion-defensa").value = "";
        document.getElementById("accion-dano-real").value = "";
        document.getElementById("accion-pa-defensa").value = 0;
        document.getElementById("accion-vel-defensa").value = 0;
        document.getElementById("accion-desc").value = "";
    };

    document.getElementById("btn-pasar-turno").onclick = function() {
        turnoActual++;
    };
    document.getElementById("btn-pasar-ronda").onclick = function() {
        rondaActual++;
        turnoActual = 1;
        aliados.forEach(a => a.pa = 8);
        enemigos.forEach(e => e.pa = 8);
        renderBandos();
    };

    function guardarDatos() {
        localStorage.setItem("combate_aliados", JSON.stringify(aliados));
        localStorage.setItem("combate_enemigos", JSON.stringify(enemigos));
        localStorage.setItem("combate_notas", JSON.stringify(chatMensajes));
        localStorage.setItem("combate_acciones", JSON.stringify(acciones));
        localStorage.setItem("combate_ronda", rondaActual);
        localStorage.setItem("combate_turno", turnoActual);
    }
    function cargarDatos() {
        const a = localStorage.getItem("combate_aliados");
        const e = localStorage.getItem("combate_enemigos");
        const n = localStorage.getItem("combate_notas");
        const ac = localStorage.getItem("combate_acciones");
        const r = localStorage.getItem("combate_ronda");
        const t = localStorage.getItem("combate_turno");
        if (a) aliados = JSON.parse(a);
        if (e) enemigos = JSON.parse(e);
        if (n) chatMensajes = JSON.parse(n);
        if (ac) acciones = JSON.parse(ac);
        if (r) rondaActual = Number(r);
        if (t) turnoActual = Number(t);
    }

    function renderChat() {
        const chatDiv = document.getElementById("chat-mensajes");
        chatDiv.innerHTML = "";
        chatMensajes.forEach((msg, idx) => {
            const div = document.createElement("div");
            div.className = "chat-msg";
            div.innerHTML = `
                <span>${msg}</span>
                <button class="btn-borrar-msg" data-idx="${idx}">🗑️</button>
            `;
            chatDiv.appendChild(div);
        });
        guardarDatos();
    }

    document.getElementById("form-chat").onsubmit = function(e) {
        e.preventDefault();
        const input = document.getElementById("input-chat");
        const texto = input.value.trim();
        if (texto) {
            chatMensajes.push(texto);
            renderChat();
            input.value = "";
        }
    };

    document.addEventListener("click", function(e) {
        if (e.target.classList.contains("btn-borrar-msg")) {
            const idx = Number(e.target.getAttribute("data-idx"));
            chatMensajes.splice(idx, 1);
            renderChat();
        }
    });

    document.getElementById("btn-limpiar-historial").onclick = function() {
        if (confirm("¿Seguro que quieres limpiar el historial de acciones?")) {
            acciones = [];
            rondaActual = 1;
            turnoActual = 1;
            aliados.forEach(a => {
                a.vit = 1000; 
                a.pa = 8;
            });
            enemigos.forEach(e => {
                e.vit = 1000;
                e.pa = 8;
            });
            renderBandos();
            renderRegistroCombate();
        }
    };

    cargarDatos();
    renderBandos();
    renderRegistroCombate();
    renderChat();
</script>
</body>
</html>